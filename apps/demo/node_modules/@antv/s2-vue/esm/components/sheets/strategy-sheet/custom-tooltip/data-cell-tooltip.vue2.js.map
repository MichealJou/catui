{"version":3,"file":"data-cell-tooltip.vue2.js","sources":["../../../../../src/components/sheets/strategy-sheet/custom-tooltip/data-cell-tooltip.vue"],"sourcesContent":["<script lang=\"ts\">\nimport type { ViewMeta, MultiData, SimpleData } from '@antv/s2';\nimport {\n  i18n,\n  getEmptyPlaceholder,\n  isUnchangedValue,\n  isUpDataValue,\n  getStrategySheetTooltipClsName as tooltipCls,\n} from '@antv/s2';\nimport { first, get, isEmpty, isFunction, isNil } from 'lodash';\nimport { defineComponent, computed, type PropType } from 'vue';\nimport type { CustomTooltipProps } from './interface';\n\nexport default defineComponent({\n  name: 'StrategySheetDataCellTooltip',\n  props: {\n    cell: {\n      type: Object as PropType<CustomTooltipProps['cell']>,\n      required: true,\n    },\n    label: {\n      type: [Object, Function] as PropType<CustomTooltipProps['label']>,\n      default: undefined,\n    },\n    showOriginalValue: {\n      type: Boolean,\n      default: false,\n    },\n    renderDerivedValue: {\n      type: Function as PropType<CustomTooltipProps['renderDerivedValue']>,\n      default: undefined,\n    },\n  },\n  setup(props) {\n    const meta = computed(() => props.cell.getMeta() as ViewMeta);\n    const spreadsheet = computed(() => meta.value.spreadsheet);\n    const metaFieldValue = computed(\n      () => meta.value?.fieldValue as MultiData<SimpleData[][]>,\n    );\n\n    const rowDescription = computed(() =>\n      spreadsheet.value.dataSet.getCustomFieldDescription(props.cell),\n    );\n\n    const rowName = computed(() => {\n      const defaultRowName = spreadsheet.value.dataSet.getCustomRowFieldName(\n        props.cell,\n      );\n      const customLabel = isFunction(props.label)\n        ? props.label(props.cell, defaultRowName)\n        : props.label;\n\n      return customLabel ?? defaultRowName;\n    });\n\n    const colLeafNode = computed(() =>\n      spreadsheet.value.facet.getColLeafNodeByIndex(meta.value.colIndex),\n    );\n\n    const derivedLabels = computed(() => {\n      try {\n        const [, ...labels] = JSON.parse(colLeafNode.value?.value!);\n\n        return labels;\n      } catch {\n        return [];\n      }\n    });\n\n    const valuesCfg = computed(\n      () => spreadsheet.value.options.style?.dataCell?.valuesCfg,\n    );\n\n    const values = computed(() => {\n      const firstValues = first(metaFieldValue.value?.values) || [\n        metaFieldValue.value,\n      ];\n\n      return {\n        value: firstValues[0],\n        derivedValues: firstValues.slice(1) as SimpleData[],\n      };\n    });\n\n    const originalValues = computed(() => {\n      const originalValuesField = get(\n        metaFieldValue.value,\n        valuesCfg.value?.originalValueField!,\n      ) as SimpleData[][];\n      const firstOriginal = first(originalValuesField) || [values.value.value];\n\n      return {\n        originalValue: firstOriginal[0],\n        derivedOriginalValues: firstOriginal.slice(1) as SimpleData[],\n      };\n    });\n\n    const emptyPlaceholder = computed(() =>\n      getEmptyPlaceholder(meta.value, spreadsheet.value.options.placeholder),\n    );\n\n    const shouldShowOriginalValue = computed(\n      () => valuesCfg.value?.showOriginalValue || props.showOriginalValue,\n    );\n\n    const getDerivedValueInfo = (derivedValue: SimpleData, index: number) => {\n      const isUnchanged = isUnchangedValue(\n        derivedValue,\n        values.value.value as SimpleData,\n      );\n      const isUp = !isUnchanged && isUpDataValue(derivedValue);\n      const isDown = !isUnchanged && !isUp;\n      const originalDerivedValue =\n        originalValues.value.derivedOriginalValues[index];\n\n      return { isUnchanged, isUp, isDown, originalDerivedValue };\n    };\n\n    return {\n      tooltipCls,\n      i18n,\n      isEmpty,\n      isNil,\n      rowName,\n      rowDescription,\n      values,\n      originalValues,\n      derivedLabels,\n      emptyPlaceholder,\n      shouldShowOriginalValue,\n      getDerivedValueInfo,\n    };\n  },\n});\n</script>\n\n<template>\n  <div :class=\"[tooltipCls(), tooltipCls('data')]\">\n    <div :class=\"tooltipCls('header')\">\n      <span class=\"header-label\">{{ rowName }}</span>\n      <span>{{ values.value ?? emptyPlaceholder }}</span>\n    </div>\n\n    <div v-if=\"shouldShowOriginalValue\" :class=\"tooltipCls('original-value')\">\n      {{\n        isNil(originalValues.originalValue)\n          ? emptyPlaceholder\n          : originalValues.originalValue\n      }}\n    </div>\n\n    <template v-if=\"!isEmpty(values.derivedValues)\">\n      <div :class=\"tooltipCls('divider')\" />\n      <ul :class=\"tooltipCls('derived-values')\">\n        <li\n          v-for=\"(derivedValue, i) in values.derivedValues\"\n          :key=\"i\"\n          class=\"derived-value-item\"\n        >\n          <span class=\"derived-value-label\">{{ derivedLabels[i] }}</span>\n          <span\n            :class=\"[\n              'derived-value-group',\n              {\n                'derived-value-trend-up': getDerivedValueInfo(derivedValue, i)\n                  .isUp,\n                'derived-value-trend-down': getDerivedValueInfo(derivedValue, i)\n                  .isDown,\n              },\n            ]\"\n          >\n            <span\n              v-if=\"!getDerivedValueInfo(derivedValue, i).isUnchanged\"\n              class=\"derived-value-trend-icon\"\n            />\n            <template\n              v-if=\"\n                renderDerivedValue?.(\n                  derivedValue,\n                  getDerivedValueInfo(derivedValue, i).originalDerivedValue,\n                  cell,\n                )\n              \"\n            >\n              {{\n                renderDerivedValue(\n                  derivedValue,\n                  getDerivedValueInfo(derivedValue, i).originalDerivedValue,\n                  cell,\n                )\n              }}\n            </template>\n            <span v-else class=\"derived-value-content\">\n              {{ derivedValue ?? emptyPlaceholder }}\n            </span>\n          </span>\n        </li>\n      </ul>\n    </template>\n\n    <div v-if=\"rowDescription\" :class=\"tooltipCls('description')\">\n      <span :class=\"tooltipCls('description-label')\">{{ i18n('说明') }}</span>\n      <span :class=\"tooltipCls('description-text')\">{{ rowDescription }}</span>\n    </div>\n  </div>\n</template>\n\n<style lang=\"less\">\n@import './index.less';\n</style>\n"],"names":["tooltipCls"],"mappings":"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"}