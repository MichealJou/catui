{"version":3,"file":"DragCopyPoint.vue2.js","sources":["../../../../../src/components/sheets/editable-sheet/drag-copy/DragCopyPoint.vue"],"sourcesContent":["<!-- eslint-disable max-lines-per-function -->\n<script lang=\"ts\">\nimport type { FrozenFacet, ScrollOffset } from '@antv/s2';\nimport {\n  DataCell,\n  FrozenGroupArea,\n  GEvent,\n  S2Event,\n  S2_PREFIX_CLS,\n} from '@antv/s2';\nimport { isEqual, pick } from 'lodash';\nimport { defineComponent, onUnmounted, ref, watch, computed } from 'vue';\nimport { useSpreadSheetInstance } from '../../../../context/SpreadSheetContext';\nimport DragCopyMask from './DragCopyMask.vue';\n\nimport './drag-copy-point.less';\n\nexport default defineComponent({\n  name: 'DragCopyPoint',\n  components: { DragCopyMask },\n  setup() {\n    const s2Ref = useSpreadSheetInstance();\n\n    const scroll = ref<ScrollOffset & { width?: number; overflow?: boolean }>({\n      scrollX: -999,\n      scrollY: -999,\n      width: 8,\n      overflow: true,\n    });\n    const position = ref({ left: -999, top: -999 });\n    const cell = ref<DataCell>();\n\n    const handleScroll = () => {\n      const spreadsheet = s2Ref.value;\n\n      if (!spreadsheet) {\n        return;\n      }\n\n      const newScroll = spreadsheet.facet.getScrollOffset();\n      const frozenGroupAreas = (spreadsheet.facet as FrozenFacet)\n        .frozenGroupAreas;\n      const rect = spreadsheet.getCanvasElement().getBoundingClientRect();\n      const cellMeta = cell.value?.getMeta();\n\n      if (!isEqual(newScroll, scroll.value)) {\n        if (cellMeta) {\n          const {\n            verticalBorderWidth: vWidth = 0,\n            horizontalBorderWidth: hWidth = 0,\n          } = cell.value!.getStyle()!.cell!;\n\n          const pointX = cellMeta.width + cellMeta.x;\n          const pointY = cellMeta.height + cellMeta.y;\n          const pointWidth =\n            pointX - newScroll.scrollX - rect.width + (vWidth + hWidth) * 2;\n          let overflow = true;\n\n          if (\n            frozenGroupAreas[FrozenGroupArea.Col].width >=\n              pointX - newScroll.scrollX - hWidth * 2 ||\n            frozenGroupAreas[FrozenGroupArea.Row].height >=\n              pointY - newScroll.scrollY - vWidth * 2 ||\n            rect.width <= pointX - newScroll.scrollX - hWidth * 2 ||\n            rect.height <=\n              pointY -\n                newScroll.scrollY +\n                frozenGroupAreas[FrozenGroupArea.Row].height\n          ) {\n            overflow = true;\n          } else {\n            overflow = false;\n          }\n\n          scroll.value = {\n            ...newScroll,\n            overflow,\n            width: 8 - (pointWidth > 0 ? pointWidth : 0),\n          };\n        } else {\n          scroll.value = { scrollX: -999, scrollY: -999, overflow: true };\n        }\n      }\n    };\n\n    const fixPosition = (event: GEvent) => {\n      const spreadsheet = s2Ref.value;\n\n      if (!spreadsheet) {\n        return;\n      }\n\n      const eventCell = spreadsheet.getCell<DataCell>(event.target);\n      const isEventCellSelected = spreadsheet.interaction.isSelectedCell(\n        eventCell!,\n      );\n\n      if (isEventCellSelected) {\n        cell.value = eventCell!;\n      } else {\n        cell.value = undefined;\n      }\n    };\n\n    const batchSelected = () => {\n      cell.value = undefined;\n    };\n\n    const onCopyFinished = () => {\n      batchSelected();\n    };\n\n    const bindEvents = () => {\n      const spreadsheet = s2Ref.value;\n\n      if (!spreadsheet) {\n        return;\n      }\n\n      spreadsheet.on(S2Event.COL_CELL_CLICK, batchSelected);\n      spreadsheet.on(S2Event.ROW_CELL_CLICK, batchSelected);\n      spreadsheet.on(S2Event.CORNER_CELL_CLICK, batchSelected);\n      spreadsheet.on(S2Event.DATA_CELL_BRUSH_SELECTION, batchSelected);\n      spreadsheet.on(S2Event.DATA_CELL_CLICK, fixPosition);\n      spreadsheet.on(S2Event.GLOBAL_SCROLL, handleScroll);\n    };\n\n    const unbindEvents = () => {\n      const spreadsheet = s2Ref.value;\n\n      if (!spreadsheet) {\n        return;\n      }\n\n      spreadsheet.off(S2Event.COL_CELL_CLICK, batchSelected);\n      spreadsheet.off(S2Event.ROW_CELL_CLICK, batchSelected);\n      spreadsheet.off(S2Event.CORNER_CELL_CLICK, batchSelected);\n      spreadsheet.off(S2Event.DATA_CELL_BRUSH_SELECTION, batchSelected);\n      spreadsheet.off(S2Event.DATA_CELL_CLICK, fixPosition);\n      spreadsheet.off(S2Event.GLOBAL_SCROLL, handleScroll);\n    };\n\n    // Watch cell changes\n    watch(cell, () => {\n      handleScroll();\n    });\n\n    // Update position when scroll or cell changes\n    watch([scroll, cell], () => {\n      const spreadsheet = s2Ref.value;\n\n      if (!spreadsheet?.getCanvasElement()) {\n        return;\n      }\n\n      if (spreadsheet && cell.value) {\n        const sampleColNode = spreadsheet.facet.getColNodes()[0];\n        const sampleColNodeHeight = sampleColNode?.height || 0;\n        const cellMeta = pick(cell.value.getMeta(), [\n          'x',\n          'y',\n          'width',\n          'height',\n          'fieldValue',\n        ]);\n\n        cellMeta.x -= scroll.value?.scrollX!;\n        cellMeta.y -= scroll.value?.scrollY! - sampleColNodeHeight;\n        position.value = {\n          left: cellMeta.x + cellMeta.width - 4,\n          top: cellMeta.y + cellMeta.height - 4,\n        };\n      }\n    });\n\n    // Watch for dataSet changes to reset cell\n    watch(\n      () => [\n        s2Ref.value?.dataSet.sortParams,\n        s2Ref.value?.dataSet.filterParams,\n      ],\n      () => {\n        if (cell.value) {\n          cell.value = undefined;\n        }\n      },\n    );\n\n    // Watch s2Ref to bind/unbind events\n    watch(\n      s2Ref,\n      (newS2, oldS2) => {\n        if (oldS2) {\n          oldS2.off(S2Event.COL_CELL_CLICK, batchSelected);\n          oldS2.off(S2Event.ROW_CELL_CLICK, batchSelected);\n          oldS2.off(S2Event.CORNER_CELL_CLICK, batchSelected);\n          oldS2.off(S2Event.DATA_CELL_BRUSH_SELECTION, batchSelected);\n          oldS2.off(S2Event.DATA_CELL_CLICK, fixPosition);\n          oldS2.off(S2Event.GLOBAL_SCROLL, handleScroll);\n        }\n\n        if (newS2) {\n          bindEvents();\n        }\n      },\n      { immediate: true },\n    );\n\n    onUnmounted(() => {\n      unbindEvents();\n    });\n\n    const pointStyle = computed(() => ({\n      display: scroll.value.overflow ? 'none' : 'block',\n      left: `${position.value.left}px`,\n      top: `${position.value.top}px`,\n      width: `${scroll.value.width}px`,\n    }));\n\n    return {\n      S2_PREFIX_CLS,\n      pointStyle,\n      onCopyFinished,\n    };\n  },\n});\n</script>\n\n<template>\n  <div\n    id=\"spreadsheet-drag-copy-point\"\n    :class=\"`${S2_PREFIX_CLS}-drag-copy-point`\"\n    :style=\"pointStyle\"\n  >\n    <DragCopyMask :onCopyFinished=\"onCopyFinished\" />\n  </div>\n</template>\n"],"names":[],"mappings":"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"}