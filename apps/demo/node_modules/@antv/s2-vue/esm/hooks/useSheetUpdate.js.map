{"version":3,"file":"useSheetUpdate.js","sources":["../../src/hooks/useSheetUpdate.ts"],"sourcesContent":["import type { S2Options, SpreadSheet } from '@antv/s2';\nimport { isProxy, reactive, watch, type ShallowRef } from 'vue';\nimport type { BaseSheetProps } from '../utils/initPropAndEmits';\n\n/**\n * props 会将所有属性用 shallowReactive 包裹起来：\n * 1. 如果是对 dataCfg 或者 options 直接替换， 那么只需要简单的通过 ()=> props.dataCfg 这种 getter 就能监听到\n * 2. 如果 dataCfg 任然是 reactive 数据，那么就存在直接修改了其中某一个属性的情况，这个时候就需要对所有的属性遍历来关联 watch 属性\n * ? 如果数量特别多时，遍历可能存在性能问题，先暂时观察一下\n */\nexport const useSheetUpdate = (\n  s2Ref: ShallowRef<SpreadSheet | undefined>,\n  props: BaseSheetProps,\n  hooks?: { before?: () => void; after: () => void },\n) => {\n  const updateFlag = reactive({\n    rerender: false,\n    reloadData: false,\n    rebuildDataset: false,\n  });\n\n  watch(\n    () => props.options,\n    (options, prevOptions) => {\n      updateFlag.rerender = true;\n\n      if (!Object.is(prevOptions?.hierarchyType, options?.hierarchyType)) {\n        updateFlag.reloadData = true;\n        updateFlag.rebuildDataset = true;\n      }\n\n      s2Ref.value?.setOptions(options as S2Options);\n      s2Ref.value?.changeSheetSize(options?.width, options?.height);\n    },\n    { deep: isProxy(props.options) },\n  );\n\n  watch(\n    () => props.dataCfg!,\n    (dataCfg, prevDataCfg) => {\n      if (\n        prevDataCfg?.fields?.columns?.length !==\n        dataCfg?.fields?.columns?.length\n      ) {\n        s2Ref.value?.facet?.clearInitColLeafNodes();\n      }\n\n      updateFlag.rerender = true;\n      updateFlag.reloadData = true;\n      s2Ref.value?.setDataCfg(dataCfg);\n    },\n    { deep: isProxy(props.dataCfg) },\n  );\n\n  watch(\n    () => props.themeCfg!,\n    (themeCfg) => {\n      updateFlag.rerender = true;\n      s2Ref.value?.setThemeCfg(themeCfg);\n    },\n    {\n      deep: isProxy(props.themeCfg),\n    },\n  );\n\n  watch(updateFlag, async (flag) => {\n    if (!flag.rerender) {\n      return;\n    }\n\n    hooks?.before?.();\n\n    const defaultRenderOptions = {\n      reloadData: flag.reloadData,\n      rebuildDataSet: flag.rebuildDataset,\n    };\n    const renderOptions =\n      props?.onUpdate?.(defaultRenderOptions) || defaultRenderOptions;\n\n    await s2Ref.value?.render(renderOptions);\n\n    props?.onUpdateAfterRender?.(renderOptions);\n\n    hooks?.after?.();\n    flag.rerender = false;\n    flag.reloadData = false;\n    flag.rebuildDataset = false;\n  });\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;AAUO,MAAM,iBAAiB,CAC5B,OACA,OACA,UACG;AACH,QAAM,aAAa,SAAS;AAAA,IAC1B,UAAU;AAAA,IACV,YAAY;AAAA,IACZ,gBAAgB;AAAA,EAAA,CACjB;AAED;AAAA,IACE,MAAM,MAAM;AAAA,IACZ,CAAC,SAAS,gBAAgB;;AACxB,iBAAW,WAAW;AAEtB,UAAI,CAAC,OAAO,GAAG,2CAAa,eAAe,mCAAS,aAAa,GAAG;AAClE,mBAAW,aAAa;AACxB,mBAAW,iBAAiB;AAAA,MAC9B;AAEA,kBAAM,UAAN,mBAAa,WAAW;AACxB,kBAAM,UAAN,mBAAa,gBAAgB,mCAAS,OAAO,mCAAS;AAAA,IACxD;AAAA,IACA,EAAE,MAAM,QAAQ,MAAM,OAAO,EAAA;AAAA,EAAE;AAGjC;AAAA,IACE,MAAM,MAAM;AAAA,IACZ,CAAC,SAAS,gBAAgB;;AACxB,YACE,sDAAa,WAAb,mBAAqB,YAArB,mBAA8B,cAC9B,8CAAS,WAAT,mBAAiB,YAAjB,mBAA0B,SAC1B;AACA,0BAAM,UAAN,mBAAa,UAAb,mBAAoB;AAAA,MACtB;AAEA,iBAAW,WAAW;AACtB,iBAAW,aAAa;AACxB,kBAAM,UAAN,mBAAa,WAAW;AAAA,IAC1B;AAAA,IACA,EAAE,MAAM,QAAQ,MAAM,OAAO,EAAA;AAAA,EAAE;AAGjC;AAAA,IACE,MAAM,MAAM;AAAA,IACZ,CAAC,aAAa;;AACZ,iBAAW,WAAW;AACtB,kBAAM,UAAN,mBAAa,YAAY;AAAA,IAC3B;AAAA,IACA;AAAA,MACE,MAAM,QAAQ,MAAM,QAAQ;AAAA,IAAA;AAAA,EAC9B;AAGF,QAAM,YAAY,CAAO,SAAS;;AAChC,QAAI,CAAC,KAAK,UAAU;AAClB;AAAA,IACF;AAEA,yCAAO,WAAP;AAEA,UAAM,uBAAuB;AAAA,MAC3B,YAAY,KAAK;AAAA,MACjB,gBAAgB,KAAK;AAAA,IAAA;AAEvB,UAAM,kBACJ,oCAAO,aAAP,+BAAkB,0BAAyB;AAE7C,WAAM,WAAM,UAAN,mBAAa,OAAO;AAE1B,yCAAO,wBAAP,+BAA6B;AAE7B,yCAAO,UAAP;AACA,SAAK,WAAW;AAChB,SAAK,aAAa;AAClB,SAAK,iBAAiB;AAAA,EACxB,EAAC;AACH;"}