{"version":3,"file":"DragCopyPoint.vue.js","sources":["../../../../../src/components/sheets/editable-sheet/drag-copy/DragCopyPoint.vue"],"sourcesContent":["<!-- eslint-disable max-lines-per-function -->\n<script lang=\"ts\">\nimport type { FrozenFacet, ScrollOffset } from '@antv/s2';\nimport {\n  DataCell,\n  FrozenGroupArea,\n  GEvent,\n  S2Event,\n  S2_PREFIX_CLS,\n} from '@antv/s2';\nimport { isEqual, pick } from 'lodash';\nimport { defineComponent, onUnmounted, ref, watch, computed } from 'vue';\nimport { useSpreadSheetInstance } from '../../../../context/SpreadSheetContext';\nimport DragCopyMask from './DragCopyMask.vue';\n\nimport './drag-copy-point.less';\n\nexport default defineComponent({\n  name: 'DragCopyPoint',\n  components: { DragCopyMask },\n  setup() {\n    const s2Ref = useSpreadSheetInstance();\n\n    const scroll = ref<ScrollOffset & { width?: number; overflow?: boolean }>({\n      scrollX: -999,\n      scrollY: -999,\n      width: 8,\n      overflow: true,\n    });\n    const position = ref({ left: -999, top: -999 });\n    const cell = ref<DataCell>();\n\n    const handleScroll = () => {\n      const spreadsheet = s2Ref.value;\n\n      if (!spreadsheet) {\n        return;\n      }\n\n      const newScroll = spreadsheet.facet.getScrollOffset();\n      const frozenGroupAreas = (spreadsheet.facet as FrozenFacet)\n        .frozenGroupAreas;\n      const rect = spreadsheet.getCanvasElement().getBoundingClientRect();\n      const cellMeta = cell.value?.getMeta();\n\n      if (!isEqual(newScroll, scroll.value)) {\n        if (cellMeta) {\n          const {\n            verticalBorderWidth: vWidth = 0,\n            horizontalBorderWidth: hWidth = 0,\n          } = cell.value!.getStyle()!.cell!;\n\n          const pointX = cellMeta.width + cellMeta.x;\n          const pointY = cellMeta.height + cellMeta.y;\n          const pointWidth =\n            pointX - newScroll.scrollX - rect.width + (vWidth + hWidth) * 2;\n          let overflow = true;\n\n          if (\n            frozenGroupAreas[FrozenGroupArea.Col].width >=\n              pointX - newScroll.scrollX - hWidth * 2 ||\n            frozenGroupAreas[FrozenGroupArea.Row].height >=\n              pointY - newScroll.scrollY - vWidth * 2 ||\n            rect.width <= pointX - newScroll.scrollX - hWidth * 2 ||\n            rect.height <=\n              pointY -\n                newScroll.scrollY +\n                frozenGroupAreas[FrozenGroupArea.Row].height\n          ) {\n            overflow = true;\n          } else {\n            overflow = false;\n          }\n\n          scroll.value = {\n            ...newScroll,\n            overflow,\n            width: 8 - (pointWidth > 0 ? pointWidth : 0),\n          };\n        } else {\n          scroll.value = { scrollX: -999, scrollY: -999, overflow: true };\n        }\n      }\n    };\n\n    const fixPosition = (event: GEvent) => {\n      const spreadsheet = s2Ref.value;\n\n      if (!spreadsheet) {\n        return;\n      }\n\n      const eventCell = spreadsheet.getCell<DataCell>(event.target);\n      const isEventCellSelected = spreadsheet.interaction.isSelectedCell(\n        eventCell!,\n      );\n\n      if (isEventCellSelected) {\n        cell.value = eventCell!;\n      } else {\n        cell.value = undefined;\n      }\n    };\n\n    const batchSelected = () => {\n      cell.value = undefined;\n    };\n\n    const onCopyFinished = () => {\n      batchSelected();\n    };\n\n    const bindEvents = () => {\n      const spreadsheet = s2Ref.value;\n\n      if (!spreadsheet) {\n        return;\n      }\n\n      spreadsheet.on(S2Event.COL_CELL_CLICK, batchSelected);\n      spreadsheet.on(S2Event.ROW_CELL_CLICK, batchSelected);\n      spreadsheet.on(S2Event.CORNER_CELL_CLICK, batchSelected);\n      spreadsheet.on(S2Event.DATA_CELL_BRUSH_SELECTION, batchSelected);\n      spreadsheet.on(S2Event.DATA_CELL_CLICK, fixPosition);\n      spreadsheet.on(S2Event.GLOBAL_SCROLL, handleScroll);\n    };\n\n    const unbindEvents = () => {\n      const spreadsheet = s2Ref.value;\n\n      if (!spreadsheet) {\n        return;\n      }\n\n      spreadsheet.off(S2Event.COL_CELL_CLICK, batchSelected);\n      spreadsheet.off(S2Event.ROW_CELL_CLICK, batchSelected);\n      spreadsheet.off(S2Event.CORNER_CELL_CLICK, batchSelected);\n      spreadsheet.off(S2Event.DATA_CELL_BRUSH_SELECTION, batchSelected);\n      spreadsheet.off(S2Event.DATA_CELL_CLICK, fixPosition);\n      spreadsheet.off(S2Event.GLOBAL_SCROLL, handleScroll);\n    };\n\n    // Watch cell changes\n    watch(cell, () => {\n      handleScroll();\n    });\n\n    // Update position when scroll or cell changes\n    watch([scroll, cell], () => {\n      const spreadsheet = s2Ref.value;\n\n      if (!spreadsheet?.getCanvasElement()) {\n        return;\n      }\n\n      if (spreadsheet && cell.value) {\n        const sampleColNode = spreadsheet.facet.getColNodes()[0];\n        const sampleColNodeHeight = sampleColNode?.height || 0;\n        const cellMeta = pick(cell.value.getMeta(), [\n          'x',\n          'y',\n          'width',\n          'height',\n          'fieldValue',\n        ]);\n\n        cellMeta.x -= scroll.value?.scrollX!;\n        cellMeta.y -= scroll.value?.scrollY! - sampleColNodeHeight;\n        position.value = {\n          left: cellMeta.x + cellMeta.width - 4,\n          top: cellMeta.y + cellMeta.height - 4,\n        };\n      }\n    });\n\n    // Watch for dataSet changes to reset cell\n    watch(\n      () => [\n        s2Ref.value?.dataSet.sortParams,\n        s2Ref.value?.dataSet.filterParams,\n      ],\n      () => {\n        if (cell.value) {\n          cell.value = undefined;\n        }\n      },\n    );\n\n    // Watch s2Ref to bind/unbind events\n    watch(\n      s2Ref,\n      (newS2, oldS2) => {\n        if (oldS2) {\n          oldS2.off(S2Event.COL_CELL_CLICK, batchSelected);\n          oldS2.off(S2Event.ROW_CELL_CLICK, batchSelected);\n          oldS2.off(S2Event.CORNER_CELL_CLICK, batchSelected);\n          oldS2.off(S2Event.DATA_CELL_BRUSH_SELECTION, batchSelected);\n          oldS2.off(S2Event.DATA_CELL_CLICK, fixPosition);\n          oldS2.off(S2Event.GLOBAL_SCROLL, handleScroll);\n        }\n\n        if (newS2) {\n          bindEvents();\n        }\n      },\n      { immediate: true },\n    );\n\n    onUnmounted(() => {\n      unbindEvents();\n    });\n\n    const pointStyle = computed(() => ({\n      display: scroll.value.overflow ? 'none' : 'block',\n      left: `${position.value.left}px`,\n      top: `${position.value.top}px`,\n      width: `${scroll.value.width}px`,\n    }));\n\n    return {\n      S2_PREFIX_CLS,\n      pointStyle,\n      onCopyFinished,\n    };\n  },\n});\n</script>\n\n<template>\n  <div\n    id=\"spreadsheet-drag-copy-point\"\n    :class=\"`${S2_PREFIX_CLS}-drag-copy-point`\"\n    :style=\"pointStyle\"\n  >\n    <DragCopyMask :onCopyFinished=\"onCopyFinished\" />\n  </div>\n</template>\n"],"names":["_resolveComponent","_openBlock","_createElementBlock","S2_PREFIX_CLS","_normalizeClass","_normalizeStyle"],"mappings":";;;;;kCAqOEA,IAAAA,iBAMM,cAAA;AAJE,SAAAC,IAAAA,UAAA,GAAAC,IAAAA,mBAAKC,OAAa;AAAA,IACvB,IAAA;AAAA,IAAA,OAAAC,IAAAA,eAAA,GAAA,KAAA,aAAA,kBAAA;AAAA,IAED,OAAAC,IAAAA,eAAiD,KAAA,UAAA;AAAA,EAAA,GAAA;AAAA;;;;;"}