{"version":3,"file":"data-cell-tooltip.vue.js","sources":["../../../../../src/components/sheets/strategy-sheet/custom-tooltip/data-cell-tooltip.vue"],"sourcesContent":["<script lang=\"ts\">\nimport type { ViewMeta, MultiData, SimpleData } from '@antv/s2';\nimport {\n  i18n,\n  getEmptyPlaceholder,\n  isUnchangedValue,\n  isUpDataValue,\n  getStrategySheetTooltipClsName as tooltipCls,\n} from '@antv/s2';\nimport { first, get, isEmpty, isFunction, isNil } from 'lodash';\nimport { defineComponent, computed, type PropType } from 'vue';\nimport type { CustomTooltipProps } from './interface';\n\nexport default defineComponent({\n  name: 'StrategySheetDataCellTooltip',\n  props: {\n    cell: {\n      type: Object as PropType<CustomTooltipProps['cell']>,\n      required: true,\n    },\n    label: {\n      type: [Object, Function] as PropType<CustomTooltipProps['label']>,\n      default: undefined,\n    },\n    showOriginalValue: {\n      type: Boolean,\n      default: false,\n    },\n    renderDerivedValue: {\n      type: Function as PropType<CustomTooltipProps['renderDerivedValue']>,\n      default: undefined,\n    },\n  },\n  setup(props) {\n    const meta = computed(() => props.cell.getMeta() as ViewMeta);\n    const spreadsheet = computed(() => meta.value.spreadsheet);\n    const metaFieldValue = computed(\n      () => meta.value?.fieldValue as MultiData<SimpleData[][]>,\n    );\n\n    const rowDescription = computed(() =>\n      spreadsheet.value.dataSet.getCustomFieldDescription(props.cell),\n    );\n\n    const rowName = computed(() => {\n      const defaultRowName = spreadsheet.value.dataSet.getCustomRowFieldName(\n        props.cell,\n      );\n      const customLabel = isFunction(props.label)\n        ? props.label(props.cell, defaultRowName)\n        : props.label;\n\n      return customLabel ?? defaultRowName;\n    });\n\n    const colLeafNode = computed(() =>\n      spreadsheet.value.facet.getColLeafNodeByIndex(meta.value.colIndex),\n    );\n\n    const derivedLabels = computed(() => {\n      try {\n        const [, ...labels] = JSON.parse(colLeafNode.value?.value!);\n\n        return labels;\n      } catch {\n        return [];\n      }\n    });\n\n    const valuesCfg = computed(\n      () => spreadsheet.value.options.style?.dataCell?.valuesCfg,\n    );\n\n    const values = computed(() => {\n      const firstValues = first(metaFieldValue.value?.values) || [\n        metaFieldValue.value,\n      ];\n\n      return {\n        value: firstValues[0],\n        derivedValues: firstValues.slice(1) as SimpleData[],\n      };\n    });\n\n    const originalValues = computed(() => {\n      const originalValuesField = get(\n        metaFieldValue.value,\n        valuesCfg.value?.originalValueField!,\n      ) as SimpleData[][];\n      const firstOriginal = first(originalValuesField) || [values.value.value];\n\n      return {\n        originalValue: firstOriginal[0],\n        derivedOriginalValues: firstOriginal.slice(1) as SimpleData[],\n      };\n    });\n\n    const emptyPlaceholder = computed(() =>\n      getEmptyPlaceholder(meta.value, spreadsheet.value.options.placeholder),\n    );\n\n    const shouldShowOriginalValue = computed(\n      () => valuesCfg.value?.showOriginalValue || props.showOriginalValue,\n    );\n\n    const getDerivedValueInfo = (derivedValue: SimpleData, index: number) => {\n      const isUnchanged = isUnchangedValue(\n        derivedValue,\n        values.value.value as SimpleData,\n      );\n      const isUp = !isUnchanged && isUpDataValue(derivedValue);\n      const isDown = !isUnchanged && !isUp;\n      const originalDerivedValue =\n        originalValues.value.derivedOriginalValues[index];\n\n      return { isUnchanged, isUp, isDown, originalDerivedValue };\n    };\n\n    return {\n      tooltipCls,\n      i18n,\n      isEmpty,\n      isNil,\n      rowName,\n      rowDescription,\n      values,\n      originalValues,\n      derivedLabels,\n      emptyPlaceholder,\n      shouldShowOriginalValue,\n      getDerivedValueInfo,\n    };\n  },\n});\n</script>\n\n<template>\n  <div :class=\"[tooltipCls(), tooltipCls('data')]\">\n    <div :class=\"tooltipCls('header')\">\n      <span class=\"header-label\">{{ rowName }}</span>\n      <span>{{ values.value ?? emptyPlaceholder }}</span>\n    </div>\n\n    <div v-if=\"shouldShowOriginalValue\" :class=\"tooltipCls('original-value')\">\n      {{\n        isNil(originalValues.originalValue)\n          ? emptyPlaceholder\n          : originalValues.originalValue\n      }}\n    </div>\n\n    <template v-if=\"!isEmpty(values.derivedValues)\">\n      <div :class=\"tooltipCls('divider')\" />\n      <ul :class=\"tooltipCls('derived-values')\">\n        <li\n          v-for=\"(derivedValue, i) in values.derivedValues\"\n          :key=\"i\"\n          class=\"derived-value-item\"\n        >\n          <span class=\"derived-value-label\">{{ derivedLabels[i] }}</span>\n          <span\n            :class=\"[\n              'derived-value-group',\n              {\n                'derived-value-trend-up': getDerivedValueInfo(derivedValue, i)\n                  .isUp,\n                'derived-value-trend-down': getDerivedValueInfo(derivedValue, i)\n                  .isDown,\n              },\n            ]\"\n          >\n            <span\n              v-if=\"!getDerivedValueInfo(derivedValue, i).isUnchanged\"\n              class=\"derived-value-trend-icon\"\n            />\n            <template\n              v-if=\"\n                renderDerivedValue?.(\n                  derivedValue,\n                  getDerivedValueInfo(derivedValue, i).originalDerivedValue,\n                  cell,\n                )\n              \"\n            >\n              {{\n                renderDerivedValue(\n                  derivedValue,\n                  getDerivedValueInfo(derivedValue, i).originalDerivedValue,\n                  cell,\n                )\n              }}\n            </template>\n            <span v-else class=\"derived-value-content\">\n              {{ derivedValue ?? emptyPlaceholder }}\n            </span>\n          </span>\n        </li>\n      </ul>\n    </template>\n\n    <div v-if=\"rowDescription\" :class=\"tooltipCls('description')\">\n      <span :class=\"tooltipCls('description-label')\">{{ i18n('说明') }}</span>\n      <span :class=\"tooltipCls('description-text')\">{{ rowDescription }}</span>\n    </div>\n  </div>\n</template>\n\n<style lang=\"less\">\n@import './index.less';\n</style>\n"],"names":["tooltipCls","_normalizeClass","_createElementVNode","_toDisplayString","shouldShowOriginalValue","_openBlock","_createElementBlock","emptyPlaceholder","originalValues","isEmpty","_createCommentVNode","_Fragment","_renderList","getDerivedValueInfo","renderDerivedValue","_a","cell","rowDescription","i18n"],"mappings":"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"}