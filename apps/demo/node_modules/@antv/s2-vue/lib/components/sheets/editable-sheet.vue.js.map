{"version":3,"file":"editable-sheet.vue.js","sources":["../../../src/components/sheets/editable-sheet.vue"],"sourcesContent":["<script lang=\"ts\">\nimport { defineComponent, computed, toRefs, watch, ref, reactive } from 'vue';\nimport type { CSSProperties } from 'vue';\nimport { Input } from 'ant-design-vue';\nimport { isNil, pick } from 'lodash';\nimport type { TargetCellInfo, S2Options, S2CellType } from '@antv/s2';\nimport { useExpose } from '../../hooks/useExpose';\nimport type { BaseSheetInitEmits } from '../../interface';\nimport { initBaseSheetProps } from '../../utils/initPropAndEmits';\nimport BaseSheet from './base-sheet.vue';\nimport { DragCopyPoint } from './editable-sheet/drag-copy';\n\nfunction buildEditProps(option: S2Options): S2Options {\n  return { ...option };\n}\n\nexport default defineComponent({\n  name: 'EditableSheet',\n  props: initBaseSheetProps(),\n  emits: [] as unknown as BaseSheetInitEmits,\n  setup(props, ctx) {\n    const s2Ref = useExpose(ctx.expose);\n    const { options: originOptions } = toRefs(props);\n\n    const inputRef = ref<HTMLInputElement>(null);\n    const targetCell = ref<S2CellType>(null);\n    const inputValue = ref<string>('');\n\n    const options = computed(() =>\n      buildEditProps(originOptions.value as S2Options),\n    ) as S2Options;\n\n    const inputStyle = reactive({\n      width: 0,\n      height: 0,\n      left: 0,\n      top: 0,\n      display: 'none',\n      zIndex: 1000,\n      position: 'absolute',\n    }) as CSSProperties;\n\n    function setInputStyle() {\n      const spreadsheet = s2Ref.value?.instance;\n      const cell = targetCell.value;\n\n      if (!spreadsheet || !cell) {\n        inputStyle.display = 'none';\n\n        return;\n      }\n\n      const scroll = spreadsheet.facet.getScrollOffset();\n      let cellPosition = pick(cell.getMeta(), ['x', 'y', 'width', 'height']);\n\n      if (isNil(cellPosition.x) || isNil(cellPosition.y)) {\n        cellPosition = {\n          x: 0,\n          y: 0,\n          width: 0,\n          height: 0,\n        };\n      }\n\n      const sampleColNode = spreadsheet.facet.getColNodes()[0];\n      const sampleColNodeHeight = sampleColNode?.height || 0;\n\n      cellPosition.x -= scroll.scrollX || 0;\n      cellPosition.y -= (scroll.scrollY || 0) - sampleColNodeHeight;\n      const {\n        x: cellLeft,\n        y: cellTop,\n        width: cellWidth,\n        height: cellHeight,\n      } = cellPosition;\n      const inSight =\n        cellTop >= 0 &&\n        cellTop <= spreadsheet.facet.getCanvasSize().height &&\n        cellLeft >= 0 &&\n        cellLeft <= spreadsheet.facet.getCanvasSize().width;\n\n      inputStyle.width = cellWidth ? `${cellWidth}px` : '0px';\n      inputStyle.height = cellHeight ? `${cellHeight}px` : '0px';\n      inputStyle.left = cellLeft ? `${cellLeft}px` : '0px';\n      inputStyle.top = cellTop ? `${cellTop}px` : '0px';\n      inputStyle.display = targetCell.value && inSight ? 'block' : 'none';\n    }\n    watch([targetCell, s2Ref.value?.instance.facet.getScrollOffset()], () => {\n      setInputStyle();\n    });\n\n    const onDataCellDbClick = (cell: TargetCellInfo) => {\n      targetCell.value = cell.target;\n      inputValue.value = cell.target.getActualText();\n      setTimeout(() => {\n        inputRef.value?.focus();\n      }, 100);\n    };\n\n    function onSave() {\n      const target = inputRef.value;\n      const cell = targetCell.value;\n      const spreadsheet = s2Ref.value?.instance;\n\n      if (!spreadsheet || !cell || !target) {\n        return;\n      }\n\n      const { rowIndex, valueField, id } = cell.getMeta();\n      const inputVal = target.value;\n      const displayData = spreadsheet.dataSet.getDisplayDataSet();\n\n      displayData[rowIndex][valueField] = inputVal;\n      // 编辑后的值作为格式化后的结果, formatter 不再触发, 避免二次格式化\n      spreadsheet.dataSet.displayFormattedValueMap?.set(id, inputVal);\n      spreadsheet.render();\n\n      targetCell.value = null;\n    }\n\n    return {\n      setInputStyle,\n      s2Ref,\n      options,\n      inputStyle,\n      onDataCellDbClick,\n      inputRef,\n      onSave,\n      inputValue,\n      Input,\n    };\n  },\n  components: {\n    BaseSheet,\n    DragCopyPoint,\n  },\n}) as unknown;\n</script>\n<template>\n  <BaseSheet\n    @dataCellDoubleClick=\"onDataCellDbClick\"\n    @scroll=\"setInputStyle\"\n    @dataCellClick=\"onSave\"\n    ref=\"s2Ref\"\n    v-bind=\"$props\"\n    :options=\"options\"\n  >\n    <template #editCell>\n      <Input\n        @blur=\"onSave\"\n        :value=\"inputValue\"\n        ref=\"inputRef\"\n        :style=\"inputStyle\"\n      />\n      <DragCopyPoint />\n    </template>\n  </BaseSheet>\n</template>\n"],"names":["_resolveComponent","_openBlock","setInputStyle","_mergeProps","onSave","_withCtx","_createVNode","inputValue","_normalizeStyle"],"mappings":";;;;;;;AA2IE,QAAA,uBAAAA,IAAAA,iBAiBY,WAjBZ;AAEG,SAAAC,cAAA,GAAQC,gBAAa,sBAAAC,IAAAA,WAAA;AAAA,IACrB,uBAAeC,KAAM;AAAA,IACtB,UAAI,KAAO;AAAA,IAAA,iBAEV,KAAA;AAAA,IAEU,KAAA;AAAA,EAAA,GAAA,KACT,QAAA,EAKE,SAAA,KAAA,QAAA,CAAA,GAAA;AAAA,IAAA,UAJKC,IAAAA,QAAED,MAAM;AAAA,MAAAE,IAAAA,YACLC,kBAAU;AAAA,QAClB,QAAI,KAAA;AAAA,QACH,OAAK,KAAA;AAAA,QAAA,KAAA;AAAA,QAER,OAAAC,IAAAA,eAAiB,KAAA,UAAA;AAAA,MAAA,GAAA,MAAA,GAAA,CAAA,UAAA,SAAA,OAAA,CAAA;AAAA;;;;;;;"}