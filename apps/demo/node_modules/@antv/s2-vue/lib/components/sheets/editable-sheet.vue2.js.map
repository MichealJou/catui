{"version":3,"file":"editable-sheet.vue2.js","sources":["../../../src/components/sheets/editable-sheet.vue"],"sourcesContent":["<script lang=\"ts\">\nimport { defineComponent, computed, toRefs, watch, ref, reactive } from 'vue';\nimport type { CSSProperties } from 'vue';\nimport { Input } from 'ant-design-vue';\nimport { isNil, pick } from 'lodash';\nimport type { TargetCellInfo, S2Options, S2CellType } from '@antv/s2';\nimport { useExpose } from '../../hooks/useExpose';\nimport type { BaseSheetInitEmits } from '../../interface';\nimport { initBaseSheetProps } from '../../utils/initPropAndEmits';\nimport BaseSheet from './base-sheet.vue';\nimport { DragCopyPoint } from './editable-sheet/drag-copy';\n\nfunction buildEditProps(option: S2Options): S2Options {\n  return { ...option };\n}\n\nexport default defineComponent({\n  name: 'EditableSheet',\n  props: initBaseSheetProps(),\n  emits: [] as unknown as BaseSheetInitEmits,\n  setup(props, ctx) {\n    const s2Ref = useExpose(ctx.expose);\n    const { options: originOptions } = toRefs(props);\n\n    const inputRef = ref<HTMLInputElement>(null);\n    const targetCell = ref<S2CellType>(null);\n    const inputValue = ref<string>('');\n\n    const options = computed(() =>\n      buildEditProps(originOptions.value as S2Options),\n    ) as S2Options;\n\n    const inputStyle = reactive({\n      width: 0,\n      height: 0,\n      left: 0,\n      top: 0,\n      display: 'none',\n      zIndex: 1000,\n      position: 'absolute',\n    }) as CSSProperties;\n\n    function setInputStyle() {\n      const spreadsheet = s2Ref.value?.instance;\n      const cell = targetCell.value;\n\n      if (!spreadsheet || !cell) {\n        inputStyle.display = 'none';\n\n        return;\n      }\n\n      const scroll = spreadsheet.facet.getScrollOffset();\n      let cellPosition = pick(cell.getMeta(), ['x', 'y', 'width', 'height']);\n\n      if (isNil(cellPosition.x) || isNil(cellPosition.y)) {\n        cellPosition = {\n          x: 0,\n          y: 0,\n          width: 0,\n          height: 0,\n        };\n      }\n\n      const sampleColNode = spreadsheet.facet.getColNodes()[0];\n      const sampleColNodeHeight = sampleColNode?.height || 0;\n\n      cellPosition.x -= scroll.scrollX || 0;\n      cellPosition.y -= (scroll.scrollY || 0) - sampleColNodeHeight;\n      const {\n        x: cellLeft,\n        y: cellTop,\n        width: cellWidth,\n        height: cellHeight,\n      } = cellPosition;\n      const inSight =\n        cellTop >= 0 &&\n        cellTop <= spreadsheet.facet.getCanvasSize().height &&\n        cellLeft >= 0 &&\n        cellLeft <= spreadsheet.facet.getCanvasSize().width;\n\n      inputStyle.width = cellWidth ? `${cellWidth}px` : '0px';\n      inputStyle.height = cellHeight ? `${cellHeight}px` : '0px';\n      inputStyle.left = cellLeft ? `${cellLeft}px` : '0px';\n      inputStyle.top = cellTop ? `${cellTop}px` : '0px';\n      inputStyle.display = targetCell.value && inSight ? 'block' : 'none';\n    }\n    watch([targetCell, s2Ref.value?.instance.facet.getScrollOffset()], () => {\n      setInputStyle();\n    });\n\n    const onDataCellDbClick = (cell: TargetCellInfo) => {\n      targetCell.value = cell.target;\n      inputValue.value = cell.target.getActualText();\n      setTimeout(() => {\n        inputRef.value?.focus();\n      }, 100);\n    };\n\n    function onSave() {\n      const target = inputRef.value;\n      const cell = targetCell.value;\n      const spreadsheet = s2Ref.value?.instance;\n\n      if (!spreadsheet || !cell || !target) {\n        return;\n      }\n\n      const { rowIndex, valueField, id } = cell.getMeta();\n      const inputVal = target.value;\n      const displayData = spreadsheet.dataSet.getDisplayDataSet();\n\n      displayData[rowIndex][valueField] = inputVal;\n      // 编辑后的值作为格式化后的结果, formatter 不再触发, 避免二次格式化\n      spreadsheet.dataSet.displayFormattedValueMap?.set(id, inputVal);\n      spreadsheet.render();\n\n      targetCell.value = null;\n    }\n\n    return {\n      setInputStyle,\n      s2Ref,\n      options,\n      inputStyle,\n      onDataCellDbClick,\n      inputRef,\n      onSave,\n      inputValue,\n      Input,\n    };\n  },\n  components: {\n    BaseSheet,\n    DragCopyPoint,\n  },\n}) as unknown;\n</script>\n<template>\n  <BaseSheet\n    @dataCellDoubleClick=\"onDataCellDbClick\"\n    @scroll=\"setInputStyle\"\n    @dataCellClick=\"onSave\"\n    ref=\"s2Ref\"\n    v-bind=\"$props\"\n    :options=\"options\"\n  >\n    <template #editCell>\n      <Input\n        @blur=\"onSave\"\n        :value=\"inputValue\"\n        ref=\"inputRef\"\n        :style=\"inputStyle\"\n      />\n      <DragCopyPoint />\n    </template>\n  </BaseSheet>\n</template>\n"],"names":["defineComponent","initBaseSheetProps","useExpose","toRefs","ref","computed","reactive","_a","pick","isNil","watch","Input","BaseSheet"],"mappings":"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"}