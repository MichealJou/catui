{"version":3,"file":"DragCopyMask.vue2.js","sources":["../../../../../src/components/sheets/editable-sheet/drag-copy/DragCopyMask.vue"],"sourcesContent":["<!-- eslint-disable max-lines-per-function -->\n<script lang=\"ts\">\nimport {\n  DataCell,\n  FrozenFacet,\n  FrozenGroupArea,\n  InteractionStateName,\n  S2Event,\n  S2_PREFIX_CLS,\n  type Point,\n} from '@antv/s2';\nimport { get, pick, throttle } from 'lodash';\nimport {\n  defineComponent,\n  onMounted,\n  onUnmounted,\n  ref,\n  watch,\n  type PropType,\n} from 'vue';\nimport { useSpreadSheetInstance } from '../../../../context/SpreadSheetContext';\n\nimport './drag-copy-mask.less';\n\nexport default defineComponent({\n  name: 'DragCopyMask',\n  props: {\n    onCopyFinished: {\n      type: Function as PropType<() => void>,\n      default: undefined,\n    },\n  },\n  setup(props) {\n    const s2Ref = useSpreadSheetInstance();\n    const startCell = ref<DataCell>();\n    const maskPosition = ref({ right: 0, bottom: 0 });\n    const dragPoint = ref<Point>();\n\n    // 利用闭包记录最近一次hover位置\n    const lastHoverPoint = { x: 0, y: 0 };\n\n    const isInCell = (point: Point, cell: DataCell) => {\n      const s2 = s2Ref.value;\n\n      if (!s2) {\n        return false;\n      }\n\n      const cellMeta = pick(cell.getMeta(), [\n        'x',\n        'y',\n        'width',\n        'height',\n        'fieldValue',\n      ]);\n      const scrollOffset = s2.facet.getScrollOffset();\n      const sampleColNode = s2.facet.getColNodes()[0];\n      const sampleColNodeHeight = sampleColNode?.height || 0;\n      const pointX = point.x;\n      const pointY = point.y;\n      const scrollOffsetY = scrollOffset?.scrollY - sampleColNodeHeight;\n      const cellMaxX = cellMeta.x - scrollOffset.scrollX + cellMeta.width + 4;\n      const cellMinX = cellMeta.x - scrollOffset.scrollX;\n      const cellMaxY = cellMeta.y - scrollOffsetY + cellMeta.height + 4;\n      const cellMinY = cellMeta.y - scrollOffsetY;\n\n      return (\n        cellMaxX >= pointX &&\n        cellMinX < pointX &&\n        cellMaxY >= pointY &&\n        cellMinY < pointY\n      );\n    };\n\n    const judgePointInView = (point: Point) => {\n      const s2 = s2Ref.value;\n\n      if (!s2) {\n        return false;\n      }\n\n      const rect = s2.getCanvasElement().getBoundingClientRect();\n      const frozenGroupAreas = (s2.facet as FrozenFacet).frozenGroupAreas;\n      const viewMinX = rect.x;\n      const viewMaxX = rect.x + rect.width;\n      const viewMinY = rect.y + frozenGroupAreas[FrozenGroupArea.Row].height;\n      const viewMaxY = rect.y + rect.height;\n\n      return (\n        point.x <= viewMaxX &&\n        point.x >= viewMinX &&\n        point.y <= viewMaxY &&\n        point.y >= viewMinY\n      );\n    };\n\n    const getCurrentHoverCell = (event: MouseEvent) => {\n      const s2 = s2Ref.value;\n\n      if (!s2) {\n        return undefined;\n      }\n\n      const rect = s2.getCanvasElement().getBoundingClientRect();\n      const allCells = s2.facet.getDataCells();\n\n      return allCells.find((dataCell) =>\n        isInCell({ y: event.y - rect.y, x: event.x - rect.x }, dataCell),\n      );\n    };\n\n    const getSelectedCellRange = (start: DataCell, end: DataCell) => {\n      const s2 = s2Ref.value;\n\n      if (!s2) {\n        return [];\n      }\n\n      const startCellMeta = start.getMeta();\n      const endCellMeta = end?.getMeta();\n      const minX = Math.min(startCellMeta.colIndex, endCellMeta.colIndex);\n      const maxX = Math.max(startCellMeta.colIndex, endCellMeta.colIndex);\n      const maxY = Math.max(startCellMeta.rowIndex, endCellMeta.rowIndex);\n      const minY = Math.min(startCellMeta.rowIndex, endCellMeta.rowIndex);\n      const allCells = s2.facet.getDataCells();\n\n      return allCells.filter((item) => {\n        const itemMeta = item.getMeta();\n\n        return (\n          itemMeta.rowIndex <= maxY &&\n          itemMeta.rowIndex >= minY &&\n          itemMeta.colIndex <= maxX &&\n          itemMeta.colIndex >= minX\n        );\n      });\n    };\n\n    const dragMove = throttle((event: MouseEvent) => {\n      const s2 = s2Ref.value;\n\n      if (!startCell.value || !s2) {\n        return;\n      }\n\n      let targetCell = getCurrentHoverCell(event);\n      let newX = event.x - dragPoint.value!.x;\n      let newY = event.y - dragPoint.value!.y;\n\n      if (!judgePointInView(event)) {\n        targetCell = getCurrentHoverCell(lastHoverPoint as MouseEvent);\n        newX = lastHoverPoint.x - dragPoint.value!.x;\n        newY = lastHoverPoint.y - dragPoint.value!.y;\n      } else {\n        lastHoverPoint.x = event.x;\n        lastHoverPoint.y = event.y;\n      }\n\n      maskPosition.value = { right: newX, bottom: newY };\n      const selectedRange = getSelectedCellRange(startCell.value, targetCell!);\n\n      s2.interaction.changeState({\n        cells: selectedRange.map((v) => v.getMeta() as any),\n        stateName: InteractionStateName.PREPARE_SELECT,\n        force: true,\n      });\n    }, 10);\n\n    const dragMouseUp = async (event: MouseEvent) => {\n      const s2 = s2Ref.value;\n\n      if (!startCell.value || !s2) {\n        return;\n      }\n\n      const targetCell =\n        getCurrentHoverCell(event) ||\n        getCurrentHoverCell(lastHoverPoint as MouseEvent);\n      const displayData = s2.dataSet.getDisplayDataSet();\n      const selectedRange = getSelectedCellRange(startCell.value, targetCell!);\n      const { fieldValue } = startCell.value.getMeta();\n\n      const changedCells = selectedRange.map((item) => {\n        const { rowIndex, valueField } = item.getMeta();\n\n        if (\n          displayData[rowIndex] &&\n          typeof displayData[rowIndex][valueField] !== 'undefined'\n        ) {\n          displayData[rowIndex][valueField] = fieldValue;\n        }\n\n        return item;\n      });\n\n      s2.interaction.changeState({\n        cells: changedCells.map((v) => v.getMeta() as any),\n        stateName: InteractionStateName.PREPARE_SELECT,\n        force: true,\n      });\n      await s2.render(true);\n\n      maskPosition.value = { right: 0, bottom: 0 };\n      s2.off(S2Event.GLOBAL_MOUSE_MOVE, dragMove);\n      s2.off(S2Event.GLOBAL_MOUSE_UP, dragMouseUp);\n      startCell.value = undefined;\n      props.onCopyFinished?.();\n    };\n\n    const dragMouseDown = (event: MouseEvent) => {\n      const s2 = s2Ref.value;\n\n      if (!s2) {\n        return;\n      }\n\n      if (get(event, 'target.id') !== 'spreadsheet-drag-copy-point') {\n        return;\n      }\n\n      const rect = (event.target as HTMLElement).getBoundingClientRect();\n      const { top, left } = get(event, 'target.style', {}) as {\n        top: string;\n        left: string;\n      };\n      const allCells = s2.facet.getDataCells();\n      const targetCell = allCells.find((v) =>\n        isInCell({ y: parseFloat(top), x: parseFloat(left) }, v),\n      );\n\n      dragPoint.value = { x: rect.x, y: rect.y };\n      startCell.value = targetCell as DataCell;\n    };\n\n    watch(startCell, (cell) => {\n      const s2 = s2Ref.value;\n\n      if (cell && s2) {\n        s2.on(S2Event.GLOBAL_MOUSE_MOVE, dragMove);\n        s2.on(S2Event.GLOBAL_MOUSE_UP, dragMouseUp);\n      }\n    });\n\n    onMounted(() => {\n      const pointElement = document.getElementById(\n        'spreadsheet-drag-copy-point',\n      );\n\n      pointElement?.addEventListener('mousedown', dragMouseDown);\n    });\n\n    onUnmounted(() => {\n      const pointElement = document.getElementById(\n        'spreadsheet-drag-copy-point',\n      );\n\n      pointElement?.removeEventListener('mousedown', dragMouseDown);\n    });\n\n    return {\n      S2_PREFIX_CLS,\n      maskPosition,\n    };\n  },\n});\n</script>\n\n<template>\n  <div\n    :class=\"`${S2_PREFIX_CLS}-drag-copy-mask`\"\n    :style=\"{\n      right: maskPosition.right > 0 ? `${maskPosition.right}px` : '0',\n      bottom: maskPosition.bottom > 0 ? `${maskPosition.bottom}px` : '0',\n      left: maskPosition.right <= 0 ? `${maskPosition.right}px` : '0',\n      top: maskPosition.bottom <= 0 ? `${maskPosition.bottom}px` : '0',\n      width: `${Math.abs(maskPosition.right)}px`,\n      height: `${Math.abs(maskPosition.bottom)}px`,\n    }\"\n  />\n</template>\n"],"names":["S2_PREFIX_CLS","_openBlock","_createElementBlock","_normalizeClass","maskPosition","_normalizeStyle"],"mappings":";;;;AA6QU,SAAA,YAAA,MAAA,QAAKA,QAAAA,QAAa,OAAA,UAAA;AAClB,SAAAC,IAAAA,UAAA,GAAAC,IAAAA,mBAAA,OAAA;AAAA,IAAA,OAAAC,IAAAA,eAAiBC,GAAY,KAAC,aAAeA,iBAAa;AAAA,IAAA,OAAAC,IAAAA,eAA+BD;AAAAA,MAAAA,OAAwEA,KAAAA,aAAa,QAAK,IAAA,GAAWA,KAAAA,aAAa,KAAK,OAAA;AAAA,MAAA,QAAuBA,KAAAA,aAAa,SAAM,IAAA,GAAWA,KAAAA,aAAa,MAAM,OAAA;AAAA,MAAA,MAAA,KAA4B,aAASA,aAAa,GAAA,KAAK,aAAA,KAAA,OAAA;AAAA,MAAA,KAAA,KAAA,aAAiCA,UAAAA,IAAY,GAAC,KAAM,aAAA,MAAA,OAAA;AAAA,MAAA,OAAA,GAAA,KAAA,IAAA,KAAA,aAAA,KAAA,CAAA;AAAA;;;;;;"}