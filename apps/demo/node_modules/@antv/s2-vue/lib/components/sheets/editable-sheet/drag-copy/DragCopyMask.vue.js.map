{"version":3,"file":"DragCopyMask.vue.js","sources":["../../../../../src/components/sheets/editable-sheet/drag-copy/DragCopyMask.vue"],"sourcesContent":["<!-- eslint-disable max-lines-per-function -->\n<script lang=\"ts\">\nimport {\n  DataCell,\n  FrozenFacet,\n  FrozenGroupArea,\n  InteractionStateName,\n  S2Event,\n  S2_PREFIX_CLS,\n  type Point,\n} from '@antv/s2';\nimport { get, pick, throttle } from 'lodash';\nimport {\n  defineComponent,\n  onMounted,\n  onUnmounted,\n  ref,\n  watch,\n  type PropType,\n} from 'vue';\nimport { useSpreadSheetInstance } from '../../../../context/SpreadSheetContext';\n\nimport './drag-copy-mask.less';\n\nexport default defineComponent({\n  name: 'DragCopyMask',\n  props: {\n    onCopyFinished: {\n      type: Function as PropType<() => void>,\n      default: undefined,\n    },\n  },\n  setup(props) {\n    const s2Ref = useSpreadSheetInstance();\n    const startCell = ref<DataCell>();\n    const maskPosition = ref({ right: 0, bottom: 0 });\n    const dragPoint = ref<Point>();\n\n    // 利用闭包记录最近一次hover位置\n    const lastHoverPoint = { x: 0, y: 0 };\n\n    const isInCell = (point: Point, cell: DataCell) => {\n      const s2 = s2Ref.value;\n\n      if (!s2) {\n        return false;\n      }\n\n      const cellMeta = pick(cell.getMeta(), [\n        'x',\n        'y',\n        'width',\n        'height',\n        'fieldValue',\n      ]);\n      const scrollOffset = s2.facet.getScrollOffset();\n      const sampleColNode = s2.facet.getColNodes()[0];\n      const sampleColNodeHeight = sampleColNode?.height || 0;\n      const pointX = point.x;\n      const pointY = point.y;\n      const scrollOffsetY = scrollOffset?.scrollY - sampleColNodeHeight;\n      const cellMaxX = cellMeta.x - scrollOffset.scrollX + cellMeta.width + 4;\n      const cellMinX = cellMeta.x - scrollOffset.scrollX;\n      const cellMaxY = cellMeta.y - scrollOffsetY + cellMeta.height + 4;\n      const cellMinY = cellMeta.y - scrollOffsetY;\n\n      return (\n        cellMaxX >= pointX &&\n        cellMinX < pointX &&\n        cellMaxY >= pointY &&\n        cellMinY < pointY\n      );\n    };\n\n    const judgePointInView = (point: Point) => {\n      const s2 = s2Ref.value;\n\n      if (!s2) {\n        return false;\n      }\n\n      const rect = s2.getCanvasElement().getBoundingClientRect();\n      const frozenGroupAreas = (s2.facet as FrozenFacet).frozenGroupAreas;\n      const viewMinX = rect.x;\n      const viewMaxX = rect.x + rect.width;\n      const viewMinY = rect.y + frozenGroupAreas[FrozenGroupArea.Row].height;\n      const viewMaxY = rect.y + rect.height;\n\n      return (\n        point.x <= viewMaxX &&\n        point.x >= viewMinX &&\n        point.y <= viewMaxY &&\n        point.y >= viewMinY\n      );\n    };\n\n    const getCurrentHoverCell = (event: MouseEvent) => {\n      const s2 = s2Ref.value;\n\n      if (!s2) {\n        return undefined;\n      }\n\n      const rect = s2.getCanvasElement().getBoundingClientRect();\n      const allCells = s2.facet.getDataCells();\n\n      return allCells.find((dataCell) =>\n        isInCell({ y: event.y - rect.y, x: event.x - rect.x }, dataCell),\n      );\n    };\n\n    const getSelectedCellRange = (start: DataCell, end: DataCell) => {\n      const s2 = s2Ref.value;\n\n      if (!s2) {\n        return [];\n      }\n\n      const startCellMeta = start.getMeta();\n      const endCellMeta = end?.getMeta();\n      const minX = Math.min(startCellMeta.colIndex, endCellMeta.colIndex);\n      const maxX = Math.max(startCellMeta.colIndex, endCellMeta.colIndex);\n      const maxY = Math.max(startCellMeta.rowIndex, endCellMeta.rowIndex);\n      const minY = Math.min(startCellMeta.rowIndex, endCellMeta.rowIndex);\n      const allCells = s2.facet.getDataCells();\n\n      return allCells.filter((item) => {\n        const itemMeta = item.getMeta();\n\n        return (\n          itemMeta.rowIndex <= maxY &&\n          itemMeta.rowIndex >= minY &&\n          itemMeta.colIndex <= maxX &&\n          itemMeta.colIndex >= minX\n        );\n      });\n    };\n\n    const dragMove = throttle((event: MouseEvent) => {\n      const s2 = s2Ref.value;\n\n      if (!startCell.value || !s2) {\n        return;\n      }\n\n      let targetCell = getCurrentHoverCell(event);\n      let newX = event.x - dragPoint.value!.x;\n      let newY = event.y - dragPoint.value!.y;\n\n      if (!judgePointInView(event)) {\n        targetCell = getCurrentHoverCell(lastHoverPoint as MouseEvent);\n        newX = lastHoverPoint.x - dragPoint.value!.x;\n        newY = lastHoverPoint.y - dragPoint.value!.y;\n      } else {\n        lastHoverPoint.x = event.x;\n        lastHoverPoint.y = event.y;\n      }\n\n      maskPosition.value = { right: newX, bottom: newY };\n      const selectedRange = getSelectedCellRange(startCell.value, targetCell!);\n\n      s2.interaction.changeState({\n        cells: selectedRange.map((v) => v.getMeta() as any),\n        stateName: InteractionStateName.PREPARE_SELECT,\n        force: true,\n      });\n    }, 10);\n\n    const dragMouseUp = async (event: MouseEvent) => {\n      const s2 = s2Ref.value;\n\n      if (!startCell.value || !s2) {\n        return;\n      }\n\n      const targetCell =\n        getCurrentHoverCell(event) ||\n        getCurrentHoverCell(lastHoverPoint as MouseEvent);\n      const displayData = s2.dataSet.getDisplayDataSet();\n      const selectedRange = getSelectedCellRange(startCell.value, targetCell!);\n      const { fieldValue } = startCell.value.getMeta();\n\n      const changedCells = selectedRange.map((item) => {\n        const { rowIndex, valueField } = item.getMeta();\n\n        if (\n          displayData[rowIndex] &&\n          typeof displayData[rowIndex][valueField] !== 'undefined'\n        ) {\n          displayData[rowIndex][valueField] = fieldValue;\n        }\n\n        return item;\n      });\n\n      s2.interaction.changeState({\n        cells: changedCells.map((v) => v.getMeta() as any),\n        stateName: InteractionStateName.PREPARE_SELECT,\n        force: true,\n      });\n      await s2.render(true);\n\n      maskPosition.value = { right: 0, bottom: 0 };\n      s2.off(S2Event.GLOBAL_MOUSE_MOVE, dragMove);\n      s2.off(S2Event.GLOBAL_MOUSE_UP, dragMouseUp);\n      startCell.value = undefined;\n      props.onCopyFinished?.();\n    };\n\n    const dragMouseDown = (event: MouseEvent) => {\n      const s2 = s2Ref.value;\n\n      if (!s2) {\n        return;\n      }\n\n      if (get(event, 'target.id') !== 'spreadsheet-drag-copy-point') {\n        return;\n      }\n\n      const rect = (event.target as HTMLElement).getBoundingClientRect();\n      const { top, left } = get(event, 'target.style', {}) as {\n        top: string;\n        left: string;\n      };\n      const allCells = s2.facet.getDataCells();\n      const targetCell = allCells.find((v) =>\n        isInCell({ y: parseFloat(top), x: parseFloat(left) }, v),\n      );\n\n      dragPoint.value = { x: rect.x, y: rect.y };\n      startCell.value = targetCell as DataCell;\n    };\n\n    watch(startCell, (cell) => {\n      const s2 = s2Ref.value;\n\n      if (cell && s2) {\n        s2.on(S2Event.GLOBAL_MOUSE_MOVE, dragMove);\n        s2.on(S2Event.GLOBAL_MOUSE_UP, dragMouseUp);\n      }\n    });\n\n    onMounted(() => {\n      const pointElement = document.getElementById(\n        'spreadsheet-drag-copy-point',\n      );\n\n      pointElement?.addEventListener('mousedown', dragMouseDown);\n    });\n\n    onUnmounted(() => {\n      const pointElement = document.getElementById(\n        'spreadsheet-drag-copy-point',\n      );\n\n      pointElement?.removeEventListener('mousedown', dragMouseDown);\n    });\n\n    return {\n      S2_PREFIX_CLS,\n      maskPosition,\n    };\n  },\n});\n</script>\n\n<template>\n  <div\n    :class=\"`${S2_PREFIX_CLS}-drag-copy-mask`\"\n    :style=\"{\n      right: maskPosition.right > 0 ? `${maskPosition.right}px` : '0',\n      bottom: maskPosition.bottom > 0 ? `${maskPosition.bottom}px` : '0',\n      left: maskPosition.right <= 0 ? `${maskPosition.right}px` : '0',\n      top: maskPosition.bottom <= 0 ? `${maskPosition.bottom}px` : '0',\n      width: `${Math.abs(maskPosition.right)}px`,\n      height: `${Math.abs(maskPosition.bottom)}px`,\n    }\"\n  />\n</template>\n"],"names":["defineComponent","useSpreadSheetInstance","ref","s2","pick","FrozenGroupArea","throttle","InteractionStateName","S2Event","get","watch","onMounted","onUnmounted","S2_PREFIX_CLS"],"mappings":"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"}